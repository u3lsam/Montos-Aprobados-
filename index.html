<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- TÍTULO DE LA PESTAÑA ACTUALIZADO -->
    <title>Aprobados</title>
    <!-- ICONO DE LA PESTAÑA ACTUALIZADO CON EMOJI -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>💰</text></svg>">
    
    <!-- Metadatos para la PWA (Aplicación Web Progresiva) -->
    <meta name="theme-color" content="#f59e0b"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Montos">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/f59e0b/ffffff?text=MC">
    <link rel="manifest" href="manifest.json">

    <!-- Incluimos Tailwind CSS para un diseño moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LIBRERÍA PARA EXPORTAR A XLSX (EXCEL) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; filter: invert(0.5); }
        #edit-modal, #confirm-modal { transition: opacity 0.3s ease-in-out; }
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background-color: #fef3c7; } /* Color ámbar claro para hover */
        .fila-registro {
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
            transform-origin: top;
        }
        .fila-registro.entering {
            opacity: 0;
            transform: scaleY(0.8);
        }
        .fila-registro.exiting {
            opacity: 0;
            transform: scaleY(0.8);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto max-w-5xl p-4 sm:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Montos Aprobados</h1>
            <p class="text-gray-600 mt-2">MyCredimedia</p>
        </header>

        <!-- Formulario para añadir nuevos registros -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <form id="registro-form" class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                <div class="form-group">
                    <label for="fecha" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                    <input type="date" id="fecha" required class="w-full px-3 py-2 bg-gray-50 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div class="form-group">
                    <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Cliente</label>
                    <input type="text" id="nombre" placeholder="Ej: Ana Rodríguez" required class="w-full px-3 py-2 bg-gray-50 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div class="form-group">
                    <label for="monto" class="block text-sm font-medium text-gray-700 mb-1">Monto Aprobado (RD$)</label>
                    <input type="number" id="monto" placeholder="Ej: 15000" min="0" step="0.01" required class="w-full px-3 py-2 bg-gray-50 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div class="form-group">
                    <label for="atendido" class="block text-sm font-medium text-gray-700 mb-1">Atendido por</label>
                    <select id="atendido" required class="w-full px-3 py-2 bg-gray-50 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="Samuel">Samuel</option>
                        <option value="Laidin">Laidin</option>
                    </select>
                </div>
                <div class="md:col-span-4 flex flex-col sm:flex-row justify-center items-center gap-4 mt-4">
                     <button type="submit" class="w-full sm:w-auto bg-amber-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-all transform hover:scale-105">
                         Añadir a la Lista
                     </button>
                     <button type="button" id="reset-btn" class="w-full sm:w-auto bg-red-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all transform hover:scale-105">
                        Reiniciar Registros
                    </button>
                     <button type="button" id="export-excel-btn" class="w-full sm:w-auto bg-green-700 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-600 transition-all transform hover:scale-105">
                         Exportar a Excel
                     </button>
                </div>
            </form>
        </div>
        
        <!-- Tabla para mostrar los datos -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="p-4 md:p-6 border-b border-gray-200">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Registros Guardados</h2>
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Buscar por nombre..." class="w-full md:w-64 pl-4 pr-10 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <svg class="absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                    </div>
                </div>
                <!-- SECCIÓN DE CONTEO Y TOTALES -->
                <div class="flex flex-col sm:flex-row justify-between items-baseline mt-4 gap-4">
                    <div id="conteo-agentes" class="text-sm font-medium text-gray-600 flex flex-wrap gap-2">
                        <!-- Los contadores se insertarán aquí por JS -->
                    </div>
                    <span id="total-monto" class="text-xl font-bold text-amber-600 self-end"></span>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                        <tr>
                            <th scope="col" class="px-6 py-3 sortable" data-sort="fecha">Fecha <span class="sort-icon"></span></th>
                            <th scope="col" class="px-6 py-3 sortable" data-sort="nombre">Nombre <span class="sort-icon"></span></th>
                            <th scope="col" class="px-6 py-3 sortable" data-sort="monto">Monto Aprobado <span class="sort-icon"></span></th>
                            <th scope="col" class="px-6 py-3 sortable" data-sort="atendidoPor">Atendido por <span class="sort-icon"></span></th>
                            <th scope="col" class="px-6 py-3 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="lista-clientes" class="divide-y"></tbody>
                </table>
                 <div id="empty-state" class="text-center p-8 text-gray-500 hidden">
                    <p>No se encontraron registros. ¡Intenta con otra búsqueda o añade uno nuevo!</p>
                 </div>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6">Editar Registro</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="mb-4">
                    <label for="edit-fecha" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                    <input type="date" id="edit-fecha" required class="w-full px-3 py-2 bg-gray-50 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div class="mb-4">
                    <label for="edit-nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Cliente</label>
                    <input type="text" id="edit-nombre" required class="w-full px-3 py-2 bg-gray-50 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div class="mb-4">
                    <label for="edit-monto" class="block text-sm font-medium text-gray-700 mb-1">Monto Aprobado (RD$)</label>
                    <input type="number" id="edit-monto" min="0" step="0.01" required class="w-full px-3 py-2 bg-gray-50 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>
                <div class="mb-6">
                    <label for="edit-atendido" class="block text-sm font-medium text-gray-700 mb-1">Atendido por</label>
                    <select id="edit-atendido" required class="w-full px-3 py-2 bg-gray-50 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="Samuel">Samuel</option>
                        <option value="Laidin">Laidin</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-edit" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-amber-500 text-white font-semibold rounded-lg hover:bg-amber-600">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md text-center">
            <h3 class="text-xl font-bold mb-4">¿Estás seguro?</h3>
            <p class="text-gray-600 mb-6">Esta acción no se puede deshacer. El registro será eliminado permanentemente.</p>
            <div class="flex justify-center gap-4">
                <button type="button" id="cancel-delete" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button type="button" id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">Sí, eliminar</button>
            </div>
        </div>
    </div>


    <script>
        // --- Script para registrar el Service Worker y el Manifiesto ---
        // 1. Crear y registrar el Manifiesto dinámicamente
        const manifest = {
            "name": "Sistema de Registros - MyCredimedia",
            "short_name": "Montos",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#f59e0b",
            "description": "Aplicación para registrar montos aprobados.",
            "icons": [
                {
                    "src": "https://placehold.co/192x192/f59e0b/ffffff?text=MC",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "https://placehold.co/512x512/f59e0b/ffffff?text=MC",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.querySelector('link[rel="manifest"]').setAttribute('href', manifestURL);

        // 2. Registrar el Service Worker
        if ('serviceWorker' in navigator) {
            const swContent = `
                self.addEventListener('install', (event) => {
                    event.waitUntil(
                        caches.open('v1').then((cache) => {
                            return cache.addAll(['/']);
                        })
                    );
                });
                self.addEventListener('fetch', (event) => {
                    event.respondWith(
                        caches.match(event.request).then((response) => {
                            return response || fetch(event.request);
                        })
                    );
                });
            `;
            const swBlob = new Blob([swContent], {type: 'application/javascript'});
            const swURL = URL.createObjectURL(swBlob);

            navigator.serviceWorker.register(swURL)
                .then(reg => console.log('Service Worker registrado con éxito.', reg))
                .catch(err => console.log('Error al registrar el Service Worker.', err));
        }


        document.addEventListener('DOMContentLoaded', function() {
            // --- SELECCIÓN DE ELEMENTOS ---
            const registroForm = document.getElementById('registro-form');
            const listaClientes = document.getElementById('lista-clientes');
            const emptyState = document.getElementById('empty-state');
            const totalMontoEl = document.getElementById('total-monto');
            const conteoAgentesEl = document.getElementById('conteo-agentes');
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const cancelEditBtn = document.getElementById('cancel-edit');
            const searchInput = document.getElementById('search-input');
            const confirmModal = document.getElementById('confirm-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const resetBtn = document.getElementById('reset-btn');

            // --- ESTADO DE LA APLICACIÓN ---
            let sortState = { column: 'fecha', direction: 'desc' };
            let recordToDeleteId = null;
            let actionToConfirm = null; 

            // --- LÓGICA DE DATOS ---
            const guardarRegistros = (registros) => localStorage.setItem('registrosTrimestrales', JSON.stringify(registros));

            const inicializarDatos = () => {
                if (localStorage.getItem('registrosTrimestrales') === null) {
                    const defaultData = [
                        { id: '1719460800001', fecha: '2025-06-27', nombre: 'OLGA FRANCISCA DEL POZO SOTO', monto: '425000', atendidoPor: 'Samuel' },
                        { id: '1719460800002', fecha: '2025-06-27', nombre: 'MARCOS EMILIANO DURAN RODRIGUEZ', monto: '300000', atendidoPor: 'Laidin' },
                        { id: '1719806400001', fecha: '2025-07-01', nombre: 'JOHN GRA WIL CABRAL RODRIGUEZ', monto: '235000', atendidoPor: 'Samuel' },
                        { id: '1719892800001', fecha: '2025-07-02', nombre: 'DIONI DANIEL PAREDES DE LA CRUZ', monto: '150000', atendidoPor: 'Laidin' },
                        { id: '1720497600001', fecha: '2025-07-09', nombre: 'GEDALIAS GERONIMO CASTILLO', monto: '170000', atendidoPor: 'Samuel' },
                        { id: '1720065600001', fecha: '2025-07-04', nombre: 'LUIS ALFONZO ORTIZ DIAZ', monto: '315000', atendidoPor: 'Laidin' },
                        { id: '1720584000001', fecha: '2025-07-10', nombre: 'ALEJO MONTES DE OCA HERNANDEZ', monto: '300000', atendidoPor: 'Samuel' },
                        { id: '1720670400001', fecha: '2025-07-11', nombre: 'SAMUEL OCTAVIO URBAEZ FELIZ', monto: '160000', atendidoPor: 'Laidin' },
                        { id: '1721102400001', fecha: '2025-07-16', nombre: 'MATIN MARTES PIERRE', monto: '360000', atendidoPor: 'Samuel' },
                        { id: '1721275200001', fecha: '2025-07-18', nombre: 'JOSE ALBERTO VINIER DE LA CRUZ', monto: '310000', atendidoPor: 'Laidin' },
                        { id: '1721361600001', fecha: '2025-07-19', nombre: 'YINEIRIZ SILVERIO PEÑA', monto: '450000', atendidoPor: 'Samuel' },
                        { id: '1721361600002', fecha: '2025-07-19', nombre: 'JUAN JOSE ESPINAL LARA', monto: '450000', atendidoPor: 'Laidin' },
                        { id: '1721102400002', fecha: '2025-07-16', nombre: 'LUIS ANTONIO LOPEZ CASTILLO', monto: '475000', atendidoPor: 'Samuel' },
                        { id: '1721966400001', fecha: '2025-07-26', nombre: 'MAICKOL MIGUEL TEJADA', monto: '250000', atendidoPor: 'Laidin' },
                        { id: '1721966400002', fecha: '2025-07-26', nombre: 'SCARLET NIDIA MARGARITA LOPEZ CRUZ', monto: '700000', atendidoPor: 'Samuel' },
                        { id: '1722312000001', fecha: '2025-07-30', nombre: 'FAUSTO LEONEL MARZAN MARTE', monto: '250000', atendidoPor: 'Laidin' },
                        { id: '1722312000002', fecha: '2025-07-30', nombre: 'JERENMY ANDREW MESA', monto: '185000', atendidoPor: 'Samuel' },
                        { id: '1722312000003', fecha: '2025-07-30', nombre: 'LUCAS FELIX PUENTE ZACARIAS', monto: '200000', atendidoPor: 'Laidin' },
                        { id: '1722312000004', fecha: '2025-07-30', nombre: 'OMAR SOSA MORILLO', monto: '275000', atendidoPor: 'Samuel' },
                        { id: '1722312000005', fecha: '2025-07-30', nombre: 'FRANCISCO PEREZ DE LA CRUZ', monto: '235000', atendidoPor: 'Laidin' },
                        { id: '1722484800001', fecha: '2025-08-01', nombre: 'HEISY LADY ROMERO MERCADO', monto: '175000', atendidoPor: 'Samuel' },
                        { id: '1722484800002', fecha: '2025-08-01', nombre: 'DAILIN MORA SANTANA', monto: '205000', atendidoPor: 'Laidin' },
                        { id: '1722916800001', fecha: '2025-08-06', nombre: 'GABRIEL PAYANO VASQUEZ', monto: '70000', atendidoPor: 'Samuel' },
                        { id: '1722916800002', fecha: '2025-08-06', nombre: 'CRISTOPHER MARRERO SUERO', monto: '325000', atendidoPor: 'Laidin' },
                        { id: '1722916800003', fecha: '2025-08-06', nombre: 'ANGELA ARGENTINA RODRIGUEZ ESTEVEZ', monto: '320000', atendidoPor: 'Samuel' },
                        { id: '1723003200001', fecha: '2025-08-07', nombre: 'EDUARDO OGANDO MORENO', monto: '205000', atendidoPor: 'Laidin' },
                        { id: '1723521600001', fecha: '2025-08-13', nombre: 'SAUL NATANAEL ENCARNACION OGANDO', monto: '300000', atendidoPor: 'Samuel' },
                        { id: '1723608000001', fecha: '2025-08-14', nombre: 'jose gabriel', monto: '650000', atendidoPor: 'Laidin' }
                    ];
                    guardarRegistros(defaultData);
                }
            };
            
            const obtenerRegistros = () => JSON.parse(localStorage.getItem('registrosTrimestrales')) || [];

            // --- RENDERIZADO Y VISTA ---
            const renderizarRegistro = (registro, isNew = false) => {
                const fila = document.createElement('tr');
                fila.className = 'fila-registro bg-white hover:bg-gray-50';
                if (isNew) {
                    fila.classList.add('entering');
                }
                fila.setAttribute('data-id', registro.id);
                const montoFormateado = parseFloat(registro.monto).toLocaleString('es-DO', { style: 'currency', currency: 'DOP' });
                fila.innerHTML = `
                    <td class="px-6 py-4">${registro.fecha}</td>
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${registro.nombre}</td>
                    <td class="px-6 py-4">${montoFormateado}</td>
                    <td class="px-6 py-4">${registro.atendidoPor}</td>
                    <td class="px-6 py-4 text-center space-x-4">
                        <button class="font-medium text-amber-600 hover:text-amber-800" onclick="abrirModalEdicion('${registro.id}')">Editar</button>
                        <button class="font-medium text-red-600 hover:text-red-800" onclick="abrirModalConfirmacion('${registro.id}')">Eliminar</button>
                    </td>
                `;
                
                if (isNew) {
                    listaClientes.prepend(fila);
                    setTimeout(() => fila.classList.remove('entering'), 50);
                } else {
                    listaClientes.appendChild(fila);
                }
            };

            const actualizarIconosDeOrden = () => {
                document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = '');
                const activeIcon = document.querySelector(`.sortable[data-sort="${sortState.column}"] .sort-icon`);
                if (activeIcon) activeIcon.textContent = sortState.direction === 'asc' ? ' ▲' : ' ▼';
            };

            const getRegistrosFiltradosYOrdenados = () => {
                let registros = obtenerRegistros();
                const searchTerm = searchInput.value.toLowerCase();
                if (searchTerm) registros = registros.filter(r => r.nombre.toLowerCase().includes(searchTerm));
                registros.sort((a, b) => {
                    const valA = a[sortState.column], valB = b[sortState.column];
                    let comparison = 0;
                    if (sortState.column === 'monto') {
                        comparison = parseFloat(valA) - parseFloat(valB);
                    } else {
                        comparison = String(valA || '').localeCompare(String(valB || ''));
                    }
                    return sortState.direction === 'asc' ? comparison : -comparison;
                });
                return registros;
            };

            const actualizarVista = (newRecordId = null) => {
                listaClientes.innerHTML = '';
                const registros = getRegistrosFiltradosYOrdenados();

                const registrosAgrupados = registros.reduce((acc, registro) => {
                    const fecha = new Date(registro.fecha + 'T00:00:00'); 
                    const mesAnio = new Intl.DateTimeFormat('es-ES', { month: 'long', year: 'numeric' }).format(fecha);
                    if (!acc[mesAnio]) {
                        acc[mesAnio] = [];
                    }
                    acc[mesAnio].push(registro);
                    return acc;
                }, {});

                const mesesOrdenados = Object.keys(registrosAgrupados).sort((a, b) => {
                    const parseMonthYear = (str) => {
                        const parts = str.split(' de ');
                        const monthStr = parts[0].toLowerCase();
                        const year = parseInt(parts[1]);
                        const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
                        const monthIndex = months.indexOf(monthStr);
                        return new Date(year, monthIndex);
                    };
                    const dateA = parseMonthYear(a);
                    const dateB = parseMonthYear(b);
                    return dateB - dateA;
                });

                mesesOrdenados.forEach(mesAnio => {
                    const grupoFila = document.createElement('tr');
                    grupoFila.innerHTML = `<td colspan="5" class="px-6 py-3 bg-amber-50 text-amber-800 font-bold text-sm capitalize">${mesAnio}</td>`;
                    listaClientes.appendChild(grupoFila);
                    registrosAgrupados[mesAnio].forEach(registro => {
                        renderizarRegistro(registro, registro.id === newRecordId);
                    });
                });
                
                actualizarIconosDeOrden();

                // --- Lógica de conteo y totales ---
                const total = registros.reduce((sum, r) => sum + parseFloat(r.monto || 0), 0);
                const conteoSamuel = registros.filter(r => r.atendidoPor === 'Samuel').length;
                const conteoLaidin = registros.filter(r => r.atendidoPor === 'Laidin').length;

                totalMontoEl.textContent = `Total: ${total.toLocaleString('es-DO', { style: 'currency', currency: 'DOP' })}`;
                conteoAgentesEl.innerHTML = `
                    <span class="inline-flex items-center gap-x-1.5 px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        Samuel: <strong class="ml-1">${conteoSamuel}</strong>
                    </span>
                    <span class="inline-flex items-center gap-x-1.5 px-3 py-1 rounded-full text-xs font-medium bg-pink-100 text-pink-800">
                        Laidin: <strong class="ml-1">${conteoLaidin}</strong>
                    </span>
                `;

                if (registros.length === 0) {
                    emptyState.classList.remove('hidden');
                    totalMontoEl.classList.add('hidden');
                    conteoAgentesEl.classList.add('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    totalMontoEl.classList.remove('hidden');
                    conteoAgentesEl.classList.remove('hidden');
                }
            };

            // --- MANEJO DE EVENTOS ---
            const anadirRegistro = (e) => {
                e.preventDefault();
                const nuevoRegistro = { 
                    id: Date.now().toString(), 
                    fecha: document.getElementById('fecha').value, 
                    nombre: document.getElementById('nombre').value, 
                    monto: document.getElementById('monto').value,
                    atendidoPor: document.getElementById('atendido').value 
                };
                const registros = obtenerRegistros();
                registros.push(nuevoRegistro);
                guardarRegistros(registros);
                actualizarVista(nuevoRegistro.id);
                registroForm.reset();
                document.getElementById('fecha').focus();
            };

            // --- LÓGICA DE MODALES ---
            const abrirModalEdicion = (id) => {
                const registro = obtenerRegistros().find(r => r.id === id);
                if (registro) {
                    document.getElementById('edit-id').value = registro.id;
                    document.getElementById('edit-fecha').value = registro.fecha;
                    document.getElementById('edit-nombre').value = registro.nombre;
                    document.getElementById('edit-monto').value = registro.monto;
                    document.getElementById('edit-atendido').value = registro.atendidoPor;
                    editModal.classList.remove('hidden');
                    setTimeout(() => editModal.classList.remove('opacity-0'), 20);
                }
            };
            window.abrirModalEdicion = abrirModalEdicion;

            const cerrarModalEdicion = () => {
                editModal.classList.add('opacity-0');
                setTimeout(() => editModal.classList.add('hidden'), 300);
            };

            const abrirModalConfirmacion = (id) => {
                recordToDeleteId = id;
                actionToConfirm = 'delete';
                confirmModal.querySelector('h3').textContent = '¿Estás seguro?';
                confirmModal.querySelector('p').textContent = 'Esta acción no se puede deshacer. El registro será eliminado permanentemente.';
                confirmModal.classList.remove('hidden');
                setTimeout(() => confirmModal.classList.remove('opacity-0'), 20);
            };
            window.abrirModalConfirmacion = abrirModalConfirmacion;

            const cerrarModalConfirmacion = () => {
                confirmModal.classList.add('opacity-0');
                setTimeout(() => {
                    confirmModal.classList.add('hidden');
                    recordToDeleteId = null;
                    actionToConfirm = null;
                }, 300);
            };
            
            const guardarCambios = (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-id').value;
                let registros = obtenerRegistros();
                const index = registros.findIndex(r => r.id === id);
                if (index > -1) {
                    registros[index] = { 
                        ...registros[index], 
                        fecha: document.getElementById('edit-fecha').value, 
                        nombre: document.getElementById('edit-nombre').value, 
                        monto: document.getElementById('edit-monto').value,
                        atendidoPor: document.getElementById('edit-atendido').value
                    };
                    guardarRegistros(registros);
                    actualizarVista();
                    cerrarModalEdicion();
                }
            };

            const eliminarRegistro = () => {
                if (recordToDeleteId) {
                    const filaAEliminar = document.querySelector(`tr[data-id='${recordToDeleteId}']`);
                    if (filaAEliminar) {
                        filaAEliminar.classList.add('exiting');
                        setTimeout(() => {
                            let registros = obtenerRegistros().filter(r => r.id !== recordToDeleteId);
                            guardarRegistros(registros);
                            actualizarVista();
                        }, 400);
                    }
                }
            };
            
            const reiniciarRegistros = () => {
                localStorage.removeItem('registrosTrimestrales');
                actualizarVista();
            };

            const handleConfirm = () => {
                if (actionToConfirm === 'delete') {
                    eliminarRegistro();
                } else if (actionToConfirm === 'reset') {
                    reiniciarRegistros();
                }
                cerrarModalConfirmacion();
            };

            const exportarAExcel = () => {
                const registros = getRegistrosFiltradosYOrdenados();
                if (registros.length === 0) {
                    alert('No hay registros para exportar.');
                    return;
                }

                // --- CÁLCULOS PARA EL RESUMEN ---
                const totalMontoExportado = registros.reduce((sum, r) => sum + parseFloat(r.monto || 0), 0);
                const conteoSamuel = registros.filter(r => r.atendidoPor === 'Samuel').length;
                const conteoLaidin = registros.filter(r => r.atendidoPor === 'Laidin').length;
                const totalRegistros = registros.length;
                const fechaGeneracion = new Date().toLocaleString('es-DO', { dateStyle: 'long', timeStyle: 'short' });

                // --- PREPARACIÓN DE DATOS PARA LA HOJA DE CÁLCULO ---
                const ws_data = [];
                const dataStartIndex = 11; // Fila donde comienzan los datos (después de encabezados y resumen)

                // Encabezado del reporte
                ws_data.push(['Reporte de Montos Aprobados']);
                ws_data.push(['MyCredimedia']);
                ws_data.push([`Generado el: ${fechaGeneracion}`]);
                ws_data.push([]); // Fila en blanco

                // Resumen
                ws_data.push(['Resumen del Reporte']);
                ws_data.push(['Total de Registros:', totalRegistros]);
                ws_data.push(['Monto Total Aprobado:', totalMontoExportado]);
                ws_data.push(['Atendidos por Samuel:', conteoSamuel]);
                ws_data.push(['Atendidos por Laidin:', conteoLaidin]);
                ws_data.push([]); // Fila en blanco

                // Encabezados de la tabla de datos
                const headers = ['Fecha', 'Nombre del Cliente', 'Monto Aprobado', 'Atendido por'];
                ws_data.push(headers);

                // Filas de datos
                registros.forEach(r => {
                    ws_data.push([
                        r.fecha,
                        r.nombre,
                        parseFloat(r.monto),
                        r.atendidoPor
                    ]);
                });
                
                // Fila de total
                const totalRowIndex = dataStartIndex + registros.length;
                ws_data.push([]); // Fila en blanco
                ws_data[totalRowIndex] = ['', 'TOTAL GENERAL', {t:'n', f:`SUM(C${dataStartIndex + 1}:C${totalRowIndex})`}, ''];

                // --- CREACIÓN DEL LIBRO DE EXCEL ---
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(ws_data);

                // --- APLICACIÓN DE ESTILOS Y FORMATOS ---
                ws['!cols'] = [ { wch: 15 }, { wch: 45 }, { wch: 20 }, { wch: 15 } ];
                ws['!merges'] = [ 
                    XLSX.utils.decode_range("A1:D1"), 
                    XLSX.utils.decode_range("A2:D2"), 
                    XLSX.utils.decode_range("A3:D3"),
                    XLSX.utils.decode_range("A5:D5")
                ];

                const styles = {
                    title: { font: { name: 'Arial', sz: 18, bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "92400E" } }, alignment: { horizontal: "center", vertical: "center" } },
                    subtitle: { font: { name: 'Arial', sz: 11, italic: true }, alignment: { horizontal: "center" } },
                    summaryTitle: { font: { name: 'Arial', sz: 14, bold: true }, fill: { fgColor: { rgb: "FBBF24" } }, alignment: { horizontal: "center" } },
                    summaryLabel: { font: { bold: true } },
                    tableHeader: { font: { bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "B45309" } }, alignment: { horizontal: "center" } },
                    totalLabel: { font: { bold: true }, alignment: { horizontal: "right" }, border: { top: { style: "thin" } } },
                    totalValue: { font: { bold: true }, numFmt: '"RD$"#,##0.00;[Red]-"RD$"#,##0.00', border: { top: { style: "thin" } } },
                    currency: { numFmt: '"RD$"#,##0.00' },
                    date: { numFmt: 'dd/mm/yyyy' },
                    zebraStripe: { fill: { fgColor: { rgb: "FEF3C7" } } }
                };
                
                // Aplicar estilos a celdas específicas
                ws['A1'].s = styles.title;
                ws['A2'].s = styles.subtitle;
                ws['A3'].s = styles.subtitle;
                ws['A5'].s = styles.summaryTitle;
                
                for(let r=5; r<9; ++r) {
                    if(ws[XLSX.utils.encode_cell({c:0, r:r})]) ws[XLSX.utils.encode_cell({c:0, r:r})].s = styles.summaryLabel;
                }
                ws['B7'].s = styles.currency;
                
                headers.forEach((h, i) => {
                    const cellRef = XLSX.utils.encode_cell({c:i, r:dataStartIndex-1});
                    if(ws[cellRef]) ws[cellRef].s = styles.tableHeader;
                });

                for (let r = dataStartIndex; r < totalRowIndex; r++) {
                    const isOddRow = (r - dataStartIndex) % 2 === 0;
                    const stripeStyle = isOddRow ? styles.zebraStripe : {};
                    ws[XLSX.utils.encode_cell({c:0, r:r})].s = { ...stripeStyle, ...styles.date };
                    ws[XLSX.utils.encode_cell({c:1, r:r})].s = stripeStyle;
                    ws[XLSX.utils.encode_cell({c:2, r:r})].s = { ...stripeStyle, ...styles.currency };
                    ws[XLSX.utils.encode_cell({c:3, r:r})].s = stripeStyle;
                }
                
                ws[XLSX.utils.encode_cell({c:1, r:totalRowIndex})].s = styles.totalLabel;
                ws[XLSX.utils.encode_cell({c:2, r:totalRowIndex})].s = styles.totalValue;

                XLSX.utils.book_append_sheet(wb, ws, 'Reporte de Aprobados');
                XLSX.writeFile(wb, `Reporte_Aprobados_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            // --- INICIALIZACIÓN Y LISTENERS ---
            inicializarDatos(); 
            
            registroForm.addEventListener('submit', anadirRegistro);
            editForm.addEventListener('submit', guardarCambios);
            cancelEditBtn.addEventListener('click', cerrarModalEdicion);
            searchInput.addEventListener('input', () => actualizarVista());
            cancelDeleteBtn.addEventListener('click', cerrarModalConfirmacion);
            confirmDeleteBtn.addEventListener('click', handleConfirm);
            exportExcelBtn.addEventListener('click', exportarAExcel);

            resetBtn.addEventListener('click', () => {
                actionToConfirm = 'reset';
                confirmModal.querySelector('h3').textContent = '¿Reiniciar todos los registros?';
                confirmModal.querySelector('p').textContent = 'Esta acción eliminará permanentemente TODOS los registros. No se puede deshacer.';
                confirmModal.classList.remove('hidden');
                setTimeout(() => confirmModal.classList.remove('opacity-0'), 20);
            });

            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;
                    sortState.column === column ? sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc' : (sortState.column = column, sortState.direction = 'desc');
                    actualizarVista();
                });
            });

            editModal.addEventListener('click', (e) => e.target === editModal && cerrarModalEdicion());
            confirmModal.addEventListener('click', (e) => e.target === confirmModal && cerrarModalConfirmacion());
            
            actualizarVista();
        });
    </script>
</body>
</html>
